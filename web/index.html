<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Doom</title>

  <script src="data.js"></script>
  <script src="sizes.js"></script>
  <script src="https://unpkg.com/aframe@0.8.2/dist/aframe-master.js"></script>
  <script src="https://unpkg.com/aframe-teleport-controls@0.3.1/dist/aframe-teleport-controls.js"></script>

  <script>
    AFRAME.registerComponent('sector', {
      schema: {
        vertices: {
          default: ['-10 10', '-10 -10', '10 -10'],
        },
        height: { default: 10 },
        face: { default: 'floor' },
      },

      init: function () {
        const { data } = this;

        const pts = [];
        for (let i = 0; i < data.vertices.length; i++) {
          const points = data.vertices[i].split(' ').map(x => parseFloat(x));
          pts.push(new THREE.Vector2(points[0], points[1] * (this.data.face === 'floor' ? -1 : 1)));
        }
        const shape = new THREE.Shape(pts);

        const extrudeSettings = {
          depth: 0,
          steps: 0,
          bevelEnabled: false,
          // bevelEnabled: true, bevelSegments: 8, steps: 8, bevelSize: 0.1, bevelThickness: 0.1 
        };
        this.geometry = new THREE.ExtrudeBufferGeometry(shape, extrudeSettings);
        this.geometry.lookAt(new THREE.Vector3(0, this.data.face === 'ceiling' ? 10000 : -10000, 0));
        this.mesh = new THREE.Mesh(this.geometry);
        this.mesh.position.y = this.data.height;
        this.el.setObject3D('mesh', this.mesh);
      }
    });
  </script>

</head>

<body>

  <a-scene>

    <a-entity id="cameraRig" position="0 0 0" rotation="0 0 0">
      <a-entity id="head" camera wasd-controls="fly: true; acceleration: 180;" look-controls></a-entity>
      <a-entity id="left-hand" teleport-controls="cameraRig: #cameraRig; teleportOrigin: #head; button: trigger; collision-entities: .floor;"
        vive-controls="hand: left" oculus-touch-controls="hand: left" microsoft-motion-controls="hand: left"
        daydream-controls="hand: left" gearvr-controls="hand: left">
      </a-entity>
      <a-entity id="right-hand" teleport-controls="cameraRig: #cameraRig; teleportOrigin: #head; button: trigger; collision-entities: .floor;"
        vive-controls="hand: right" oculus-touch-controls="hand: right" microsoft-motion-controls="hand: right"
        daydream-controls="hand: right" gearvr-controls="hand: right">
      </a-entity>
    </a-entity>


    <a-entity light="type: directional; color: #FFF; intensity: 0.5" position="2 20 0"></a-entity>
    <a-entity light="type: ambient; color: #ccc"></a-entity>

    <!-- <img id="sky_sphere-texture" src="assets/SKY1.png"> -->
    <!-- <a-sky color="#EEEEFF" src="#sky_sphere-texture"></a-sky> -->
    
    <a-sky color="#EEEEFF"></a-sky>
    <a-image src="skys/01_FR.png" width="1000" height="1000" position="0 0 -500" rotation="0 0 0"></a-image>
    <a-image src="skys/01_BK.png" width="1000" height="1000" position="0 0 500" rotation="0 180 0"></a-image>
    <a-image src="skys/01_RT.png" width="1000" height="1000" position="-500 0 0" rotation="0 90 0"></a-image>
    <a-image src="skys/01_LF.png" width="1000" height="1000" position="500 0 0" rotation="0 -90 0"></a-image>
    <a-image src="skys/01_UP.png" width="1000" height="1000" position="0 500 0" rotation="270 0 0"></a-image>
    <a-image src="skys/01_DN.png" width="1000" height="1000" position="0 -500 0" rotation="-90 0 0"></a-image>

    <script>

      const addFloorsAndCeilings = () => {
        const { polygons } = map;
        // .filter(d => d.sectorId === 28);

        for (let sectorIndex = 0; sectorIndex < polygons.length; sectorIndex += 1) {
          const { floor, ceiling, floorHeight, ceilingHeight, polygon, isSky } = polygons[sectorIndex];
          const vertices = polygon.map(polygon => `${polygon[0]} ${polygon[1]}`).join(', ');

          const floorPolygon = document.createElement('a-entity');
          floorPolygon.setAttribute('sector', `vertices: ${vertices}; height: ${floorHeight}; face: floor;`);
          // floorPolygon.setAttribute('material', `color: #fff; side: front;`);
          floorPolygon.setAttribute('material', `shader: flat; src: assets/${floor}.png; side: front; repeat: 1.0001 1.0001;`);
          floorPolygon.setAttribute('class', `floor`);
          document.querySelector('a-scene').appendChild(floorPolygon);

          if (!isSky) {
            const ceilingPolygon = document.createElement('a-entity');
            ceilingPolygon.setAttribute('sector', `vertices: ${vertices}; height: ${ceilingHeight}; face: ceiling;`);
            ceilingPolygon.setAttribute('material', `shader: flat; src: assets/${ceiling}.png; side: front; repeat: 1.0001 1.0001;`);
            ceilingPolygon.setAttribute('class', `ceiling`);
            document.querySelector('a-scene').appendChild(ceilingPolygon);
          }
        }
      }
      addFloorsAndCeilings();

      const addWalls = () => {
        for (let planeIndex = 0; planeIndex < map.planes.length; planeIndex += 1) {
          const { width, x, y, z, height, rotation, src } = map.planes[planeIndex];

          const sizeFactorX = 31;
          const sizeFactorY = 31;
          const { width: imageWidth, height: imageHeight } = sizes[src];
          const xRepeat = (width / imageWidth) * sizeFactorX;
          const yRepeat = (height / imageHeight) * sizeFactorY;

          if (height > 0.0001) {
            const wallPlane = document.createElement('a-plane');
            wallPlane.setAttribute('position', `${x} ${y} ${z * -1}`);
            wallPlane.setAttribute('rotation', `0 ${rotation * (180 / Math.PI)} 0`);
            wallPlane.setAttribute('width', width);
            wallPlane.setAttribute('height', height);
            wallPlane.setAttribute('material', `src: assets/${src}.png; side: both; repeat: ${xRepeat} ${yRepeat};`);
            wallPlane.setAttribute('class', `wall`);
            document.querySelector('a-scene').appendChild(wallPlane);
          }
        }
      }
      addWalls();

    </script>



  </a-scene>
</body>

</html>